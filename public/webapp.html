<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Auto Source</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body{margin:0;font:14px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .w{display:flex;min-height:100vh;align-items:center;justify-content:center}
    .t{opacity:.7;text-align:center;padding:24px}
  </style>
</head>
<body>
<div class="w"><div class="t">Секунду…</div></div>
<script>
(function(){
  const BOT = "rgnr_assistant_bot"; // ваш username бота
  const tg  = window.Telegram && window.Telegram.WebApp;

  function grab(s){ const m=(s||"").match(/^[A-Za-z0-9_-]{1,64}$/); return m? m[0] : ""; }
  function qs(name){ return new URLSearchParams(location.search).get(name) || ""; }

  // Если открыто не в Telegram — пробуем вызвать tg://
  if (!tg) { location.href = `tg://resolve?domain=${BOT}`; return; }

  tg.ready();

  // slug берём из start_param или из query (?startapp=...|?src=...)
  const sp   = (tg.initDataUnsafe && tg.initDataUnsafe.start_param) || "";
  const slug = grab(sp) || grab(qs("startapp")) || grab(qs("src"));

  // Отправляем на свой сервер (проверка подписи initData по TOKEN)
  const payload = { initData: tg.initData || "", src: slug };
  fetch("/api/webapp-src", {
    method:"POST",
    headers:{ "content-type":"application/json" },
    body: JSON.stringify(payload)
  }).catch(() => { /* игнор, всё равно откроем чат */ });

  // Открываем чат бота и закрываем WebApp
  setTimeout(function(){
    try { tg.openTelegramLink(`https://t.me/${BOT}`); } catch(e){}
    setTimeout(function(){ try{ tg.close(); }catch(e){} }, 150);
  }, 150);
})();
</script>
</body>
</html>
